<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>AchkounE - Gestion Auto-Ã‰cole</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #1a56db;
    --primary-dark: #1240a8;
    --accent: #f97316;
    --bg: #f0f4ff;
    --card: #ffffff;
    --text: #1e293b;
    --muted: #64748b;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --border: #e2e8f0;
    --shadow: 0 4px 24px rgba(26,86,219,0.10);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 16px rgba(26,86,219,0.25);
  }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-icon { background: var(--accent); border-radius: 10px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
  .logo-text { color: white; font-size: 18px; font-weight: 700; }
  .logo-text span { color: #ffd700; }
  .header-pills { display: flex; gap: 8px; }
  .pill { background: rgba(255,255,255,0.15); border-radius: 20px; padding: 4px 10px; color: white; font-size: 11px; font-weight: 600; }
  .pill b { color: #ffd700; }

  nav { background: white; display: flex; border-bottom: 2px solid var(--border); overflow-x: auto; scrollbar-width: none; position: sticky; top: 68px; z-index: 99; }
  nav::-webkit-scrollbar { display: none; }
  .nav-btn { flex: none; padding: 13px 18px; border: none; background: none; font-family: 'Poppins', sans-serif; font-size: 12px; font-weight: 600; color: var(--muted); cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; white-space: nowrap; }
  .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

  .content { padding: 16px; max-width: 600px; margin: 0 auto; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  .card { background: var(--card); border-radius: 16px; padding: 18px; box-shadow: var(--shadow); margin-bottom: 14px; }
  .card-title { font-size: 14px; font-weight: 700; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
  .card-title .icon { background: var(--bg); border-radius: 8px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 15px; }

  .form-grid { display: flex; flex-direction: column; gap: 11px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 11px; }
  label { display: block; font-size: 10px; font-weight: 700; color: var(--muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  input, select, textarea { width: 100%; padding: 10px 13px; border: 1.5px solid var(--border); border-radius: 10px; font-family: 'Poppins', sans-serif; font-size: 13px; color: var(--text); background: var(--bg); transition: border-color 0.2s; outline: none; }
  input:focus, select:focus, textarea:focus { border-color: var(--primary); background: white; }
  .input-error { border-color: var(--danger) !important; }
  .error-msg { font-size: 11px; color: var(--danger); margin-top: 3px; }

  .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 11px 18px; border: none; border-radius: 10px; font-family: 'Poppins', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-primary:hover { background: var(--primary-dark); }
  .btn-success { background: var(--success); color: white; }
  .btn-danger { background: var(--danger); color: white; }
  .btn-warning { background: var(--warning); color: white; }
  .btn-whatsapp { background: #25d366; color: white; }
  .btn-accent { background: var(--accent); color: white; }
  .btn-outline { background: white; color: var(--primary); border: 1.5px solid var(--primary); }
  .btn-full { width: 100%; }
  .btn-sm { font-size: 11px; padding: 7px 12px; border-radius: 8px; }

  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
  .stat-card { background: var(--card); border-radius: 14px; padding: 14px; box-shadow: var(--shadow); text-align: center; }
  .stat-value { font-size: 26px; font-weight: 900; color: var(--primary); }
  .stat-label { font-size: 10px; color: var(--muted); font-weight: 600; margin-top: 3px; }
  .stat-card.accent .stat-value { color: var(--accent); }
  .stat-card.success .stat-value { color: var(--success); }
  .stat-card.danger .stat-value { color: var(--danger); }

  .search-box { position: relative; margin-bottom: 12px; }
  .search-box input { padding-left: 38px; background: white; }
  .search-icon { position: absolute; left: 13px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 15px; }

  .filters { display: flex; gap: 8px; margin-bottom: 12px; overflow-x: auto; scrollbar-width: none; padding-bottom: 4px; }
  .filters::-webkit-scrollbar { display: none; }
  .filter-btn { flex: none; padding: 7px 14px; border: 1.5px solid var(--border); border-radius: 20px; background: white; font-family: 'Poppins', sans-serif; font-size: 11px; font-weight: 600; color: var(--muted); cursor: pointer; transition: all 0.2s; white-space: nowrap; }
  .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

  .client-item { background: var(--card); border-radius: 14px; padding: 14px; margin-bottom: 10px; box-shadow: var(--shadow); border-left: 4px solid var(--primary); transition: transform 0.2s; }
  .client-item:active { transform: scale(0.98); }
  .client-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
  .client-name { font-weight: 700; font-size: 14px; }
  .client-serial { font-size: 10px; color: var(--muted); font-weight: 500; }

  .status-badge { font-size: 10px; font-weight: 700; padding: 3px 9px; border-radius: 20px; }
  .status-en-cours { background: #dbeafe; color: #1e40af; }
  .status-reussi { background: #d1fae5; color: #065f46; }
  .status-echoue { background: #fee2e2; color: #991b1b; }
  .status-abandonne { background: #f3f4f6; color: #374151; }

  .pay-badge { font-size: 10px; font-weight: 700; padding: 3px 9px; border-radius: 20px; margin-left: 4px; }
  .pay-solde { background: #d1fae5; color: #065f46; }
  .pay-partiel { background: #fef3c7; color: #92400e; }
  .pay-non { background: #fee2e2; color: #991b1b; }

  .client-info { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px; color: var(--muted); margin-bottom: 8px; }
  .progress-bar { height: 6px; background: var(--border); border-radius: 10px; overflow: hidden; margin: 6px 0; }
  .progress-fill { height: 100%; border-radius: 10px; background: linear-gradient(90deg, var(--success), #34d399); transition: width 0.5s; }
  .client-actions { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }

  .payment-summary { background: linear-gradient(135deg, #1a56db0d, #f973160d); border: 1.5px solid var(--border); border-radius: 12px; padding: 12px; margin-top: 10px; }
  .payment-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 12px; }
  .payment-row:last-child { margin-bottom: 0; }
  .amount { font-weight: 700; font-size: 14px; }
  .amount.green { color: var(--success); }
  .amount.red { color: var(--danger); }

  .avance-item { display: flex; justify-content: space-between; align-items: center; padding: 9px 12px; background: var(--bg); border-radius: 10px; margin-bottom: 6px; font-size: 12px; }
  .avance-amount { font-weight: 700; color: var(--success); }

  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: flex-end; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: white; border-radius: 24px 24px 0 0; padding: 20px 18px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
  .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 10px; margin: 0 auto 18px; }

  .section-title { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin: 16px 0 8px; }

  .pub-filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
  .pub-filter-item { padding: 10px; border: 1.5px solid var(--border); border-radius: 10px; text-align: center; cursor: pointer; font-size: 11px; font-weight: 600; color: var(--muted); transition: all 0.2s; }
  .pub-filter-item.selected { border-color: var(--primary); background: #dbeafe; color: var(--primary); }

  .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--text); color: white; padding: 10px 22px; border-radius: 30px; font-size: 12px; font-weight: 600; z-index: 300; transition: transform 0.3s; white-space: nowrap; }
  .toast.show { transform: translateX(-50%) translateY(0); }

  .empty { text-align: center; padding: 36px 20px; color: var(--muted); }
  .empty-icon { font-size: 44px; margin-bottom: 10px; }

  .export-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  .edit-field { display: flex; align-items: center; gap: 8px; }
  .edit-field input { flex: 1; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">ğŸš—</div>
    <div class="logo-text">Achkoun<span>E</span></div>
  </div>
  <div class="header-pills">
    <div class="pill">Clients: <b id="hdr-total">0</b></div>
    <div class="pill">Reste: <b id="hdr-reste">0</b> DH</div>
  </div>
</header>

<nav>
  <button class="nav-btn active" onclick="showTab('dashboard',this)">ğŸ“Š Tableau</button>
  <button class="nav-btn" onclick="showTab('clients',this)">ğŸ‘¥ Clients</button>
  <button class="nav-btn" onclick="showTab('add',this)">â• Ajouter</button>
  <button class="nav-btn" onclick="showTab('pub',this)">ğŸ“¢ PublicitÃ©</button>
  <button class="nav-btn" onclick="showTab('export',this)">ğŸ“¤ Export</button>
</nav>

<!-- DASHBOARD -->
<div id="tab-dashboard" class="tab-content active">
  <div class="content">
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-value" id="d-total">0</div><div class="stat-label">ğŸ‘¥ Clients</div></div>
      <div class="stat-card accent"><div class="stat-value" id="d-ca">0</div><div class="stat-label">ğŸ’° CA Total DH</div></div>
      <div class="stat-card success"><div class="stat-value" id="d-paye">0</div><div class="stat-label">âœ… PayÃ© DH</div></div>
      <div class="stat-card danger"><div class="stat-value" id="d-reste">0</div><div class="stat-label">â³ Reste DH</div></div>
    </div>
    <div class="stats-grid">
      <div class="stat-card success"><div class="stat-value" id="d-reussi">0</div><div class="stat-label">ğŸ‰ RÃ©ussis</div></div>
      <div class="stat-card danger"><div class="stat-value" id="d-echoue">0</div><div class="stat-label">âŒ Ã‰chouÃ©s</div></div>
    </div>
    <div class="card">
      <div class="card-title"><div class="icon">âš ï¸</div> ImpayÃ©s urgents</div>
      <div id="d-debiteurs"></div>
    </div>
  </div>
</div>

<!-- CLIENTS -->
<div id="tab-clients" class="tab-content">
  <div class="content">
    <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input type="text" placeholder="Rechercher nom, sÃ©rie, tÃ©lÃ©phone..." id="searchInput" oninput="renderClients()">
    </div>
    <div class="filters" id="statusFilters">
      <button class="filter-btn active" data-filter="tous" onclick="setFilter('tous',this)">Tous</button>
      <button class="filter-btn" data-filter="en-cours" onclick="setFilter('en-cours',this)">ğŸ”µ En cours</button>
      <button class="filter-btn" data-filter="reussi" onclick="setFilter('reussi',this)">ğŸŸ¢ RÃ©ussis</button>
      <button class="filter-btn" data-filter="echoue" onclick="setFilter('echoue',this)">ğŸ”´ Ã‰chouÃ©s</button>
      <button class="filter-btn" data-filter="abandonne" onclick="setFilter('abandonne',this)">âš« AbandonnÃ©s</button>
      <button class="filter-btn" data-filter="solde" onclick="setFilter('solde',this)">âœ… SoldÃ©s</button>
      <button class="filter-btn" data-filter="impaye" onclick="setFilter('impaye',this)">â— ImpayÃ©s</button>
    </div>
    <div id="clientsList"></div>
  </div>
</div>

<!-- ADD CLIENT -->
<div id="tab-add" class="tab-content">
  <div class="content">
    <div class="card">
      <div class="card-title"><div class="icon">ğŸ‘¤</div> Nouveau Client</div>
      <div class="form-grid">
        <div>
          <label>NumÃ©ro de sÃ©rie *</label>
          <input type="text" id="f-serial" placeholder="Ex: AE001">
          <div class="error-msg" id="err-serial"></div>
        </div>
        <div class="form-row">
          <div>
            <label>PrÃ©nom *</label>
            <input type="text" id="f-prenom" placeholder="PrÃ©nom">
            <div class="error-msg" id="err-prenom"></div>
          </div>
          <div>
            <label>Nom *</label>
            <input type="text" id="f-nom" placeholder="Nom">
            <div class="error-msg" id="err-nom"></div>
          </div>
        </div>
        <div>
          <label>Date de naissance</label>
          <input type="date" id="f-dob">
        </div>
        <div>
          <label>Adresse</label>
          <input type="text" id="f-adresse" placeholder="Adresse complÃ¨te">
        </div>
        <div>
          <label>TÃ©lÃ©phone / WhatsApp *</label>
          <input type="tel" id="f-tel" placeholder="06XXXXXXXX" oninput="validateTel('f-tel','err-tel')">
          <div class="error-msg" id="err-tel"></div>
        </div>
        <div>
          <label>Gmail</label>
          <input type="email" id="f-email" placeholder="exemple@gmail.com">
        </div>
        <div>
          <label>Statut</label>
          <select id="f-statut">
            <option value="en-cours">ğŸ”µ En cours</option>
            <option value="reussi">ğŸŸ¢ RÃ©ussi</option>
            <option value="echoue">ğŸ”´ Ã‰chouÃ©</option>
            <option value="abandonne">âš« AbandonnÃ©</option>
          </select>
        </div>
        <div class="section-title">ğŸ’° Paiement</div>
        <div>
          <label>Prix total fixÃ© (DH) *</label>
          <input type="number" id="f-prix" placeholder="Ex: 3000">
          <div class="error-msg" id="err-prix"></div>
        </div>
        <div>
          <label>PremiÃ¨re avance (DH)</label>
          <input type="number" id="f-avance" placeholder="Ex: 500">
        </div>
        <button class="btn btn-primary btn-full" onclick="addClient()">âœ… Enregistrer le client</button>
      </div>
    </div>
  </div>
</div>

<!-- PUBLICITE -->
<div id="tab-pub" class="tab-content">
  <div class="content">
    <div class="card">
      <div class="card-title"><div class="icon">ğŸ¯</div> SÃ©lectionner les destinataires</div>
      <div class="pub-filter-grid" id="pubFilters">
        <div class="pub-filter-item selected" data-pub="tous" onclick="setPubFilter(this)">ğŸ‘¥ Tous les clients</div>
        <div class="pub-filter-item" data-pub="impaye" onclick="setPubFilter(this)">â— ImpayÃ©s</div>
        <div class="pub-filter-item" data-pub="solde" onclick="setPubFilter(this)">âœ… SoldÃ©s</div>
        <div class="pub-filter-item" data-pub="en-cours" onclick="setPubFilter(this)">ğŸ”µ En cours</div>
        <div class="pub-filter-item" data-pub="reussi" onclick="setPubFilter(this)">ğŸŸ¢ RÃ©ussis</div>
        <div class="pub-filter-item" data-pub="echoue" onclick="setPubFilter(this)">ğŸ”´ Ã‰chouÃ©s</div>
      </div>
      <div id="pub-count" style="font-size:12px;color:var(--primary);font-weight:700;margin-bottom:12px;"></div>

    <div class="section-title">Message <span style="font-size:10px;color:var(--primary);font-weight:600">â€” utilisez [prÃ©nom] [nom] [reste] pour personnaliser</span></div>
      <textarea id="pub-msg" rows="7" oninput="updatePubCount();renderPubNums()">Bonjour [prÃ©nom] ! ğŸ‘‹

ğŸš— Auto-Ã‰cole AchkounE
ğŸ“ 06 61 37 22 27

Nous vous contactons concernant votre dossier.
Reste Ã  payer : [reste]

Pour toute question, n'hÃ©sitez pas Ã  nous appeler.
Merci de votre confiance ! ğŸ™</textarea>

      <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px;">
        <button class="btn btn-outline btn-full" onclick="copyNumsPub()">ğŸ“‹ Copier tous les numÃ©ros</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><div class="icon">ğŸ“¤</div> Envoyer un par un</div>
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px">Appuyez sur ğŸ’¬ pour chaque client â€” WhatsApp s'ouvre avec le message personnalisÃ© prÃªt Ã  envoyer !</p>
      <div id="pub-clients-list"></div>
    </div>
  </div>
</div>

<!-- EXPORT -->
<div id="tab-export" class="tab-content">
  <div class="content">
    <div class="card">
      <div class="card-title"><div class="icon">ğŸ“¤</div> Exporter les donnÃ©es</div>
      <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">Choisissez le format d'export de vos clients.</p>
      <div class="export-btns">
        <button class="btn btn-success btn-full" onclick="exportCSV()">ğŸ“Š Export CSV (Excel)</button>
        <button class="btn btn-danger btn-full" onclick="exportPDF()">ğŸ“„ Export PDF</button>
        <button class="btn btn-primary btn-full" onclick="exportJSON()">ğŸ’¾ Sauvegarde JSON</button>
        <button class="btn btn-warning btn-full" onclick="importJSON()">ğŸ“¥ Importer JSON</button>
      </div>
      <input type="file" id="import-file" accept=".json" style="display:none" onchange="doImport(event)">
    </div>
    <div class="card">
      <div class="card-title"><div class="icon">ğŸ“Š</div> AperÃ§u export</div>
      <div id="export-preview" style="font-size:12px;color:var(--muted);overflow-x:auto;"></div>
    </div>
  </div>
</div>

<!-- MODAL CLIENT -->
<div class="modal-overlay" id="clientModal" onclick="handleModalClick(event)">
  <div class="modal" id="modalBox">
    <div class="modal-handle"></div>
    <div id="modal-content"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let clients = JSON.parse(localStorage.getItem('achkoune-v2') || '[]');
let currentFilter = 'tous';
let pubFilter = 'tous';

function save() {
  localStorage.setItem('achkoune-v2', JSON.stringify(clients));
  updateHeader();
  updateDashboard();
}

function showTab(tab, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  if(btn) btn.classList.add('active');
  if(tab === 'clients') renderClients();
  if(tab === 'pub') { updatePubCount(); renderPubNums(); }
  if(tab === 'export') renderExportPreview();
}

function toast(msg, duration=2500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

function getReste(c) {
  const p = (c.avances||[]).reduce((s,a)=>s+Number(a.montant),0);
  return Math.max(0, Number(c.prix) - p);
}
function getPaye(c) { return (c.avances||[]).reduce((s,a)=>s+Number(a.montant),0); }

function updateHeader() {
  document.getElementById('hdr-total').textContent = clients.length;
  document.getElementById('hdr-reste').textContent = clients.reduce((s,c)=>s+getReste(c),0).toLocaleString();
}

function updateDashboard() {
  document.getElementById('d-total').textContent = clients.length;
  document.getElementById('d-ca').textContent = clients.reduce((s,c)=>s+Number(c.prix||0),0).toLocaleString();
  document.getElementById('d-paye').textContent = clients.reduce((s,c)=>s+getPaye(c),0).toLocaleString();
  document.getElementById('d-reste').textContent = clients.reduce((s,c)=>s+getReste(c),0).toLocaleString();
  document.getElementById('d-reussi').textContent = clients.filter(c=>c.statut==='reussi').length;
  document.getElementById('d-echoue').textContent = clients.filter(c=>c.statut==='echoue').length;

  const deb = clients.filter(c=>getReste(c)>0);
  const el = document.getElementById('d-debiteurs');
  el.innerHTML = deb.length === 0
    ? '<div class="empty"><div class="empty-icon">ğŸ‰</div><p style="font-size:13px">Tous les clients sont Ã  jour !</p></div>'
    : deb.map(c=>`
        <div class="avance-item" onclick="openClient('${c.id}')">
          <div><div style="font-weight:700;font-size:13px">${c.prenom} ${c.nom}</div><div style="font-size:10px;color:var(--muted)">${c.tel}</div></div>
          <div style="color:var(--danger);font-weight:700;font-size:13px">${getReste(c).toLocaleString()} DH</div>
        </div>`).join('');
}

function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderClients();
}

function filterClients(list) {
  return list.filter(c => {
    if(currentFilter === 'tous') return true;
    if(currentFilter === 'solde') return getReste(c) === 0;
    if(currentFilter === 'impaye') return getReste(c) > 0;
    return c.statut === currentFilter;
  });
}

function renderClients() {
  const q = (document.getElementById('searchInput')?.value||'').toLowerCase();
  let list = clients.filter(c=>(c.prenom+' '+c.nom+' '+c.serial+' '+c.tel).toLowerCase().includes(q));
  list = filterClients(list);
  const el = document.getElementById('clientsList');
  if(list.length===0){el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ‘¥</div><p>Aucun client trouvÃ©</p></div>';return;}
  el.innerHTML = list.map(c=>{
    const paye=getPaye(c), reste=getReste(c), pct=Math.min(100,Math.round(paye/c.prix*100));
    const statusLabels={' en-cours':'ğŸ”µ En cours','reussi':'ğŸŸ¢ RÃ©ussi','echoue':'ğŸ”´ Ã‰chouÃ©','abandonne':'âš« AbandonnÃ©'};
    return `<div class="client-item">
      <div class="client-header">
        <div>
          <div class="client-name">${c.prenom} ${c.nom}</div>
          <div class="client-serial"># ${c.serial} â€” ${c.createdAt}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end">
          <span class="status-badge status-${c.statut||'en-cours'}">${statusLabels[c.statut]||'ğŸ”µ En cours'}</span>
          <span class="pay-badge ${reste===0?'pay-solde':pct>0?'pay-partiel':'pay-non'}">${reste===0?'âœ… SoldÃ©':pct>0?'â³ Partiel':'â— Non payÃ©'}</span>
        </div>
      </div>
      <div class="client-info">
        <span>ğŸ“ ${c.tel}</span>
        <span>ğŸ“… ${c.dob||'N/A'}</span>
        <span>ğŸ’° ${Number(c.prix).toLocaleString()} DH</span>
        <span style="color:var(--danger)">Reste: ${reste.toLocaleString()} DH</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:8px">
        <span>${paye.toLocaleString()} DH payÃ© (${pct}%)</span>
        <span style="color:var(--danger);font-weight:700">${reste.toLocaleString()} DH restant</span>
      </div>
      <div class="client-actions">
        <a href="https://wa.me/212${c.tel.replace(/^0/,'').replace(/\s/g,'')}" target="_blank" class="btn btn-whatsapp btn-sm">ğŸ’¬ WA</a>
        <button class="btn btn-primary btn-sm" onclick="openClient('${c.id}')">ğŸ’° DÃ©tails</button>
        <button class="btn btn-warning btn-sm" onclick="openEdit('${c.id}')">âœï¸ Modifier</button>
        <button class="btn btn-danger btn-sm" onclick="deleteClient('${c.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

// VALIDATE
function validateTel(inputId, errId) {
  const val = document.getElementById(inputId).value.trim();
  const el = document.getElementById(errId);
  const input = document.getElementById(inputId);
  const valid = /^0[6-7]\d{8}$/.test(val.replace(/\s/g,''));
  if(val && !valid) {
    el.textContent = 'âš ï¸ Format invalide (ex: 0661372227)';
    input.classList.add('input-error');
  } else {
    el.textContent = '';
    input.classList.remove('input-error');
  }
}

function addClient() {
  let valid = true;
  const fields = [
    {id:'f-serial', err:'err-serial', label:'sÃ©rie'},
    {id:'f-prenom', err:'err-prenom', label:'prÃ©nom'},
    {id:'f-nom', err:'err-nom', label:'nom'},
    {id:'f-tel', err:'err-tel', label:'tÃ©lÃ©phone'},
    {id:'f-prix', err:'err-prix', label:'prix'},
  ];
  fields.forEach(f=>{
    const v = document.getElementById(f.id).value.trim();
    const el = document.getElementById(f.err);
    if(!v){el.textContent=`âš ï¸ Ce champ est obligatoire`;document.getElementById(f.id).classList.add('input-error');valid=false;}
    else{el.textContent='';document.getElementById(f.id).classList.remove('input-error');}
  });

  const tel = document.getElementById('f-tel').value.trim().replace(/\s/g,'');
  if(tel && !/^0[6-7]\d{8}$/.test(tel)) {
    document.getElementById('err-tel').textContent = 'âš ï¸ Format invalide (ex: 0661372227)';
    document.getElementById('f-tel').classList.add('input-error');
    valid = false;
  }

  const serial = document.getElementById('f-serial').value.trim();
  if(clients.find(c=>c.serial===serial)){
    document.getElementById('err-serial').textContent='âŒ Ce numÃ©ro de sÃ©rie existe dÃ©jÃ ';
    document.getElementById('f-serial').classList.add('input-error');
    valid=false;
  }

  if(!valid){toast('âš ï¸ Corrigez les erreurs');return;}

  const avance = Number(document.getElementById('f-avance').value)||0;
  const client = {
    id: Date.now().toString(),
    serial, prenom: document.getElementById('f-prenom').value.trim(),
    nom: document.getElementById('f-nom').value.trim(),
    dob: document.getElementById('f-dob').value,
    adresse: document.getElementById('f-adresse').value.trim(),
    tel, email: document.getElementById('f-email').value.trim(),
    statut: document.getElementById('f-statut').value,
    prix: Number(document.getElementById('f-prix').value),
    avances: avance>0?[{montant:avance,date:new Date().toLocaleDateString('fr-FR')}]:[],
    createdAt: new Date().toLocaleDateString('fr-FR')
  };
  clients.push(client);
  save();
  ['f-serial','f-prenom','f-nom','f-dob','f-adresse','f-tel','f-email','f-prix','f-avance'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f-statut').value='en-cours';
  toast('âœ… Client enregistrÃ© !');
  showTab('clients', document.querySelectorAll('.nav-btn')[1]);
}

function openClient(id) {
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  const paye=getPaye(c), reste=getReste(c), pct=Math.min(100,Math.round(paye/c.prix*100));
  document.getElementById('modal-content').innerHTML = `
    <h2 style="font-size:17px;font-weight:800;margin-bottom:2px">${c.prenom} ${c.nom}</h2>
    <p style="font-size:11px;color:var(--muted);margin-bottom:14px"># ${c.serial} â€” Inscrit le ${c.createdAt}</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;font-size:12px;margin-bottom:14px">
      <div>ğŸ“ ${c.tel}</div><div>ğŸ“… ${c.dob||'N/A'}</div>
      <div>ğŸ“ ${c.adresse||'N/A'}</div><div>âœ‰ï¸ ${c.email||'N/A'}</div>
    </div>
    <div class="payment-summary">
      <div class="payment-row"><span>ğŸ’° Prix total</span><span class="amount">${c.prix.toLocaleString()} DH</span></div>
      <div class="payment-row"><span>âœ… Total payÃ©</span><span class="amount green">${paye.toLocaleString()} DH</span></div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div class="payment-row"><span>â³ Reste Ã  payer</span><span class="amount red">${reste.toLocaleString()} DH</span></div>
    </div>
    <div class="section-title">Historique avances</div>
    <div class="avance-list">
      ${(c.avances||[]).length===0?'<p style="font-size:12px;color:var(--muted)">Aucune avance</p>':
        c.avances.map((a,i)=>`<div class="avance-item">
          <div><div class="avance-amount">+${Number(a.montant).toLocaleString()} DH</div><div style="font-size:10px;color:var(--muted)">${a.date}</div></div>
          <button onclick="removeAvance('${id}',${i})" style="background:none;border:none;font-size:16px;cursor:pointer">ğŸ—‘ï¸</button>
        </div>`).join('')}
    </div>
    <div class="section-title">Ajouter une avance</div>
    <div style="display:flex;gap:8px;margin-bottom:14px">
      <input type="number" id="new-avance" placeholder="Montant (DH)" style="flex:1">
      <button class="btn btn-success" onclick="addAvance('${id}')">+ Ajouter</button>
    </div>
    <div style="display:flex;gap:8px">
      <a href="https://wa.me/212${c.tel.replace(/^0/,'').replace(/\s/g,'')}" target="_blank" class="btn btn-whatsapp" style="flex:1">ğŸ’¬ WhatsApp</a>
      <button class="btn btn-primary" style="flex:1" onclick="closeModal()">âœ“ Fermer</button>
    </div>`;
  document.getElementById('clientModal').classList.add('open');
}

function openEdit(id) {
  const c = clients.find(x=>x.id===id);
  if(!c) return;
  document.getElementById('modal-content').innerHTML = `
    <h2 style="font-size:16px;font-weight:800;margin-bottom:14px">âœï¸ Modifier â€” ${c.prenom} ${c.nom}</h2>
    <div class="form-grid">
      <div><label>NumÃ©ro de sÃ©rie</label><input id="e-serial" value="${c.serial}"><div class="error-msg" id="e-err-serial"></div></div>
      <div class="form-row">
        <div><label>PrÃ©nom</label><input id="e-prenom" value="${c.prenom}"></div>
        <div><label>Nom</label><input id="e-nom" value="${c.nom}"></div>
      </div>
      <div><label>Date de naissance</label><input type="date" id="e-dob" value="${c.dob||''}"></div>
      <div><label>Adresse</label><input id="e-adresse" value="${c.adresse||''}"></div>
      <div>
        <label>TÃ©lÃ©phone / WhatsApp</label>
        <input type="tel" id="e-tel" value="${c.tel}" oninput="validateTel('e-tel','e-err-tel')">
        <div class="error-msg" id="e-err-tel"></div>
      </div>
      <div><label>Gmail</label><input type="email" id="e-email" value="${c.email||''}"></div>
      <div><label>Statut</label>
        <select id="e-statut">
          <option value="en-cours" ${c.statut==='en-cours'?'selected':''}>ğŸ”µ En cours</option>
          <option value="reussi" ${c.statut==='reussi'?'selected':''}>ğŸŸ¢ RÃ©ussi</option>
          <option value="echoue" ${c.statut==='echoue'?'selected':''}>ğŸ”´ Ã‰chouÃ©</option>
          <option value="abandonne" ${c.statut==='abandonne'?'selected':''}>âš« AbandonnÃ©</option>
        </select>
      </div>
      <div><label>Prix total (DH)</label><input type="number" id="e-prix" value="${c.prix}"></div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button class="btn btn-primary" style="flex:1" onclick="saveEdit('${id}')">ğŸ’¾ Enregistrer</button>
        <button class="btn btn-outline" style="flex:1" onclick="closeModal()">Annuler</button>
      </div>
    </div>`;
  document.getElementById('clientModal').classList.add('open');
}

function saveEdit(id) {
  const c = clients.find(x=>x.id===id);
  const tel = document.getElementById('e-tel').value.trim().replace(/\s/g,'');
  if(tel && !/^0[6-7]\d{8}$/.test(tel)) {
    document.getElementById('e-err-tel').textContent='âš ï¸ Format invalide (ex: 0661372227)';
    return;
  }
  c.serial = document.getElementById('e-serial').value.trim();
  c.prenom = document.getElementById('e-prenom').value.trim();
  c.nom = document.getElementById('e-nom').value.trim();
  c.dob = document.getElementById('e-dob').value;
  c.adresse = document.getElementById('e-adresse').value.trim();
  c.tel = tel;
  c.email = document.getElementById('e-email').value.trim();
  c.statut = document.getElementById('e-statut').value;
  c.prix = Number(document.getElementById('e-prix').value);
  save();
  closeModal();
  renderClients();
  toast('âœ… Modifications enregistrÃ©es !');
}

function addAvance(id) {
  const c = clients.find(x=>x.id===id);
  const m = Number(document.getElementById('new-avance').value);
  if(!m||m<=0){toast('âš ï¸ Montant invalide');return;}
  if(!c.avances) c.avances=[];
  c.avances.push({montant:m,date:new Date().toLocaleDateString('fr-FR')});
  save();
  openClient(id);
  renderClients();
  toast('âœ… Avance ajoutÃ©e !');
}

function removeAvance(id,idx) {
  const c=clients.find(x=>x.id===id);
  c.avances.splice(idx,1);
  save();
  openClient(id);
  renderClients();
  toast('ğŸ—‘ï¸ Avance supprimÃ©e');
}

function deleteClient(id) {
  if(!confirm('Supprimer ce client dÃ©finitivement ?')) return;
  clients=clients.filter(c=>c.id!==id);
  save();
  renderClients();
  toast('ğŸ—‘ï¸ Client supprimÃ©');
}

function closeModal() { document.getElementById('clientModal').classList.remove('open'); }
function handleModalClick(e) { if(e.target===document.getElementById('clientModal')) closeModal(); }

// PUBLICITE
function setPubFilter(el) {
  document.querySelectorAll('.pub-filter-item').forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');
  pubFilter = el.dataset.pub;
  updatePubCount();
  renderPubNums();
}

function getPubClients() {
  if(pubFilter==='tous') return clients;
  if(pubFilter==='impaye') return clients.filter(c=>getReste(c)>0);
  if(pubFilter==='solde') return clients.filter(c=>getReste(c)===0);
  return clients.filter(c=>c.statut===pubFilter);
}

function updatePubCount() {
  const list = getPubClients();
  document.getElementById('pub-count').textContent = `ğŸ“¤ ${list.length} client(s) sÃ©lectionnÃ©(s)`;
}

function renderPubNums() {
  const list = getPubClients();
  const el = document.getElementById('pub-clients-list');
  if(!el) return;
  if(list.length===0){el.innerHTML='<p style="color:var(--muted);font-size:13px">Aucun client dans cette sÃ©lection</p>';return;}
  el.innerHTML = list.map((c,i)=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
      <div>
        <div style="font-weight:700;font-size:13px">${i+1}. ${c.prenom} ${c.nom}</div>
        <div style="font-size:11px;color:var(--muted)">${c.tel} â€” ${getReste(c)>0?'<span style="color:var(--danger)">Reste: '+getReste(c).toLocaleString()+' DH</span>':'<span style="color:var(--success)">âœ… SoldÃ©</span>'}</div>
      </div>
      <a href="${getWaLink(c)}" target="_blank" class="btn btn-whatsapp btn-sm">ğŸ’¬ Envoyer</a>
    </div>`).join('');
}

function getWaLink(c) {
  const msg = document.getElementById('pub-msg').value
    .replace(/\[prÃ©nom\]/gi, c.prenom)
    .replace(/\[nom\]/gi, c.nom)
    .replace(/\[reste\]/gi, getReste(c).toLocaleString() + ' DH');
  const num = '212' + c.tel.replace(/^0/,'').replace(/\s/g,'');
  return `https://wa.me/${num}?text=${encodeURIComponent(msg)}`;
}

function copyNumsPub() {
  const list = getPubClients();
  if(list.length===0){toast('Aucun client');return;}
  navigator.clipboard.writeText(list.map(c=>c.tel).join('\n'));
  toast(`ğŸ“‹ ${list.length} numÃ©ros copiÃ©s !`);
}

// EXPORT
function renderExportPreview() {
  const el = document.getElementById('export-preview');
  if(clients.length===0){el.innerHTML='<p>Aucun client Ã  afficher</p>';return;}
  el.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:11px">
    <tr style="background:var(--primary);color:white">
      <th style="padding:6px">SÃ©rie</th><th>Nom</th><th>TÃ©l</th><th>Prix</th><th>PayÃ©</th><th>Reste</th>
    </tr>
    ${clients.map((c,i)=>`<tr style="background:${i%2?'var(--bg)':'white'}">
      <td style="padding:5px">${c.serial}</td>
      <td>${c.prenom} ${c.nom}</td>
      <td>${c.tel}</td>
      <td>${c.prix}</td>
      <td>${getPaye(c)}</td>
      <td style="color:var(--danger);font-weight:700">${getReste(c)}</td>
    </tr>`).join('')}
  </table>`;
}

function exportCSV() {
  const headers = ['SÃ©rie','PrÃ©nom','Nom','Date Naissance','Adresse','TÃ©lÃ©phone','Email','Statut','Prix Total','Total PayÃ©','Reste','Date Inscription'];
  const rows = clients.map(c=>[
    c.serial,c.prenom,c.nom,c.dob||'',c.adresse||'',c.tel,c.email||'',
    c.statut||'en-cours',c.prix,getPaye(c),getReste(c),c.createdAt
  ].map(v=>`"${v}"`).join(','));
  const csv = [headers.join(','),...rows].join('\n');
  download('achkoune-clients.csv', 'data:text/csv;charset=utf-8,' + encodeURIComponent('\uFEFF'+csv));
  toast('ğŸ“Š Export CSV tÃ©lÃ©chargÃ© !');
}

function exportPDF() {
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>AchkounE - Clients</title>
  <style>body{font-family:Arial;font-size:12px}h1{color:#1a56db}table{width:100%;border-collapse:collapse}th{background:#1a56db;color:white;padding:8px}td{padding:6px;border-bottom:1px solid #eee}.reste{color:red;font-weight:bold}</style></head><body>
  <h1>ğŸš— AchkounE â€” Liste des Clients</h1>
  <p>ExportÃ© le ${new Date().toLocaleDateString('fr-FR')} â€” ${clients.length} clients</p>
  <table><tr><th>SÃ©rie</th><th>Nom</th><th>TÃ©lÃ©phone</th><th>Statut</th><th>Prix</th><th>PayÃ©</th><th>Reste</th></tr>
  ${clients.map(c=>`<tr><td>${c.serial}</td><td>${c.prenom} ${c.nom}</td><td>${c.tel}</td><td>${c.statut||'en-cours'}</td><td>${c.prix} DH</td><td>${getPaye(c)} DH</td><td class="reste">${getReste(c)} DH</td></tr>`).join('')}
  </table></body></html>`);
  w.document.close();
  w.print();
}

function exportJSON() {
  download('achkoune-backup.json', 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(clients, null, 2)));
  toast('ğŸ’¾ Sauvegarde JSON tÃ©lÃ©chargÃ©e !');
}

function importJSON() { document.getElementById('import-file').click(); }
function doImport(e) {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if(!Array.isArray(data)) throw new Error();
      clients = data;
      save();
      toast(`âœ… ${clients.length} clients importÃ©s !`);
      renderClients();
    } catch { toast('âŒ Fichier invalide'); }
  };
  reader.readAsText(file);
}

function download(filename, dataUrl) {
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = filename;
  a.click();
}

// Init
updateHeader();
updateDashboard();
renderClients();
setTimeout(()=>{updatePubCount();renderPubNums();},100);
</script>
</body>
</html>
