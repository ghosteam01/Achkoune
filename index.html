<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AchkounE</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --blue: #1a56db; --blue2: #1240a8; --orange: #f97316;
  --bg: #f0f4ff; --white: #ffffff; --text: #1e293b; --gray: #64748b;
  --green: #10b981; --red: #ef4444; --border: #e2e8f0;
  --shadow: 0 4px 20px rgba(26,86,219,0.10);
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
header { background: linear-gradient(135deg, var(--blue), var(--blue2)); padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 16px rgba(26,86,219,0.3); }
.logo { display: flex; align-items: center; gap: 10px; }
.logo-ico { background: var(--orange); border-radius: 12px; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
.logo-txt { color: white; font-size: 20px; font-weight: 700; }
.logo-txt span { color: #ffd700; }
.hpills { display: flex; gap: 6px; }
.hpill { background: rgba(255,255,255,0.18); border-radius: 20px; padding: 4px 11px; color: white; font-size: 11px; font-weight: 600; }
.hpill b { color: #ffd700; }
nav { background: white; display: flex; border-bottom: 2px solid var(--border); overflow-x: auto; scrollbar-width: none; position: sticky; top: 66px; z-index: 99; }
nav::-webkit-scrollbar { display: none; }
.nbtn { flex: none; padding: 13px 15px; border: none; background: none; font-family: 'Poppins', sans-serif; font-size: 12px; font-weight: 600; color: var(--gray); cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; }
.nbtn.on { color: var(--blue); border-bottom-color: var(--blue); }
.page { display: none; padding: 14px; max-width: 600px; margin: 0 auto; }
.page.on { display: block; }
.card { background: var(--white); border-radius: 16px; padding: 16px; box-shadow: var(--shadow); margin-bottom: 14px; }
.ctitle { font-size: 14px; font-weight: 700; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
.cico { background: var(--bg); border-radius: 8px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 15px; }
.sgrid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
.scard { background: var(--white); border-radius: 14px; padding: 14px; box-shadow: var(--shadow); text-align: center; }
.sval { font-size: 26px; font-weight: 900; color: var(--blue); }
.slbl { font-size: 10px; color: var(--gray); font-weight: 600; margin-top: 3px; }
.scard.ora .sval { color: var(--orange); }
.scard.grn .sval { color: var(--green); }
.scard.red .sval { color: var(--red); }
.fg { display: flex; flex-direction: column; gap: 11px; }
.frow { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
label { display: block; font-size: 10px; font-weight: 700; color: var(--gray); margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; }
input, select, textarea { width: 100%; padding: 10px 13px; border: 1.5px solid var(--border); border-radius: 10px; font-family: 'Poppins', sans-serif; font-size: 13px; color: var(--text); background: var(--bg); outline: none; -webkit-appearance: none; }
input:focus, select:focus, textarea:focus { border-color: var(--blue); background: white; }
.einp { border-color: var(--red) !important; background: #fff5f5 !important; }
.emsg { font-size: 11px; color: var(--red); margin-top: 2px; min-height: 14px; }
.btn { display: inline-flex; align-items: center; justify-content: center; gap: 5px; padding: 11px 16px; border: none; border-radius: 10px; font-family: 'Poppins', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; text-decoration: none; -webkit-appearance: none; }
.btn-blue { background: var(--blue); color: white; }
.btn-green { background: var(--green); color: white; }
.btn-red { background: var(--red); color: white; }
.btn-wa { background: #25d366; color: white; }
.btn-orange { background: var(--orange); color: white; }
.btn-out { background: white; color: var(--blue); border: 1.5px solid var(--blue); }
.btn-gray { background: var(--bg); color: var(--gray); border: 1.5px solid var(--border); }
.btn-full { width: 100%; }
.btn-sm { font-size: 11px; padding: 7px 11px; border-radius: 8px; }
.sbox { position: relative; margin-bottom: 10px; }
.sbox input { padding-left: 38px; background: white; }
.sico { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); }
.fltrs { display: flex; gap: 7px; margin-bottom: 10px; overflow-x: auto; scrollbar-width: none; padding-bottom: 2px; }
.fltrs::-webkit-scrollbar { display: none; }
.fbtn { flex: none; padding: 6px 13px; border: 1.5px solid var(--border); border-radius: 20px; background: white; font-family: 'Poppins', sans-serif; font-size: 11px; font-weight: 600; color: var(--gray); cursor: pointer; white-space: nowrap; }
.fbtn.on { background: var(--blue); color: white; border-color: var(--blue); }
.citem { background: var(--white); border-radius: 14px; padding: 14px; margin-bottom: 10px; box-shadow: var(--shadow); border-left: 4px solid var(--blue); }
.chead { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.cname { font-weight: 700; font-size: 14px; }
.cserial { font-size: 10px; color: var(--gray); margin-top: 1px; }
.cbadges { display: flex; flex-direction: column; gap: 3px; align-items: flex-end; }
.badge { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 20px; }
.b-encours { background: #dbeafe; color: #1e40af; }
.b-reussi { background: #d1fae5; color: #065f46; }
.b-echoue { background: #fee2e2; color: #991b1b; }
.b-abandonne { background: #f3f4f6; color: #374151; }
.b-solde { background: #d1fae5; color: #065f46; }
.b-partiel { background: #fef3c7; color: #92400e; }
.b-nonpaye { background: #fee2e2; color: #991b1b; }
.cinfo { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px; color: var(--gray); margin-bottom: 7px; }
.pbar { height: 7px; background: var(--border); border-radius: 10px; overflow: hidden; margin: 5px 0; }
.pfill { height: 100%; border-radius: 10px; background: linear-gradient(90deg, var(--green), #34d399); }
.cfoot { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
.psum { background: linear-gradient(135deg, #f0f4ff, #fff7ed); border: 1.5px solid var(--border); border-radius: 12px; padding: 13px; margin-top: 10px; }
.prow { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 12px; }
.prow:last-child { margin-bottom: 0; }
.pamt { font-weight: 700; font-size: 14px; }
.pamt.grn { color: var(--green); }
.pamt.red { color: var(--red); }
.aitem { display: flex; justify-content: space-between; align-items: center; padding: 9px 12px; background: var(--bg); border-radius: 10px; margin-bottom: 6px; font-size: 12px; }
.aamt { font-weight: 700; color: var(--green); }
.adate { font-size: 10px; color: var(--gray); margin-top: 1px; }
.pgfltrs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
.pgf { padding: 10px; border: 1.5px solid var(--border); border-radius: 10px; text-align: center; cursor: pointer; font-size: 11px; font-weight: 600; color: var(--gray); }
.pgf.on { border-color: var(--blue); background: #dbeafe; color: var(--blue); }
.stitle { font-size: 10px; font-weight: 700; color: var(--gray); text-transform: uppercase; letter-spacing: 0.8px; margin: 14px 0 8px; border-left: 3px solid var(--orange); padding-left: 8px; }
.modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: flex-end; justify-content: center; }
.modal-bg.on { display: flex; }
.modal { background: white; border-radius: 22px 22px 0 0; padding: 18px 16px; width: 100%; max-width: 600px; max-height: 88vh; overflow-y: auto; }
.mhandle { width: 40px; height: 4px; background: var(--border); border-radius: 10px; margin: 0 auto 16px; }
.expbtns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.empty { text-align: center; padding: 36px 16px; color: var(--gray); }
.eico { font-size: 44px; margin-bottom: 10px; }
.toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(120px); background: var(--text); color: white; padding: 11px 22px; border-radius: 30px; font-size: 12px; font-weight: 600; z-index: 300; white-space: nowrap; transition: transform 0.3s ease; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
.toast.on { transform: translateX(-50%) translateY(0); }
.divider { display: flex; justify-content: space-between; font-size: 10px; color: var(--gray); margin-bottom: 8px; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-ico">üöó</div>
    <div class="logo-txt">Achkoun<span>E</span></div>
  </div>
  <div class="hpills">
    <div class="hpill">üë• <b id="h-total">0</b></div>
    <div class="hpill">üí∞ <b id="h-reste">0</b> DH</div>
  </div>
</header>

<nav>
  <button class="nbtn on" onclick="goTab('dashboard',this)">üìä Tableau</button>
  <button class="nbtn" onclick="goTab('clients',this)">üë• Clients</button>
  <button class="nbtn" onclick="goTab('ajouter',this)">‚ûï Ajouter</button>
  <button class="nbtn" onclick="goTab('pub',this)">üì¢ Pub</button>
  <button class="nbtn" onclick="goTab('export',this)">üì§ Export</button>
</nav>

<div id="page-dashboard" class="page on">
  <div class="sgrid">
    <div class="scard"><div class="sval" id="d-total">0</div><div class="slbl">üë• Clients</div></div>
    <div class="scard ora"><div class="sval" id="d-ca">0</div><div class="slbl">üí∞ CA Total DH</div></div>
    <div class="scard grn"><div class="sval" id="d-paye">0</div><div class="slbl">‚úÖ Paye DH</div></div>
    <div class="scard red"><div class="sval" id="d-reste">0</div><div class="slbl">‚è≥ Reste DH</div></div>
    <div class="scard grn"><div class="sval" id="d-reussi">0</div><div class="slbl">üéâ Reussis</div></div>
    <div class="scard red"><div class="sval" id="d-echoue">0</div><div class="slbl">‚ùå Echoues</div></div>
  </div>
  <div class="card">
    <div class="ctitle"><div class="cico">‚ö†Ô∏è</div> Impayes urgents</div>
    <div id="d-impay"></div>
  </div>
</div>

<div id="page-clients" class="page">
  <div class="sbox">
    <span class="sico">üîç</span>
    <input type="text" id="srch" placeholder="Rechercher nom, serie, telephone..." oninput="renderClients()">
  </div>
  <div class="fltrs">
    <button class="fbtn on" data-f="tous" onclick="setF('tous',this)">Tous</button>
    <button class="fbtn" data-f="en-cours" onclick="setF('en-cours',this)">üîµ En cours</button>
    <button class="fbtn" data-f="reussi" onclick="setF('reussi',this)">üü¢ Reussis</button>
    <button class="fbtn" data-f="echoue" onclick="setF('echoue',this)">üî¥ Echoues</button>
    <button class="fbtn" data-f="abandonne" onclick="setF('abandonne',this)">‚ö´ Abandonnes</button>
    <button class="fbtn" data-f="solde" onclick="setF('solde',this)">‚úÖ Soldes</button>
    <button class="fbtn" data-f="impaye" onclick="setF('impaye',this)">‚ùó Impayes</button>
  </div>
  <div id="clist"></div>
</div>

<div id="page-ajouter" class="page">
  <div class="card">
    <div class="ctitle"><div class="cico">üë§</div> Nouveau Client</div>
    <div class="fg">
      <div>
        <label>üî¢ Numero de serie *</label>
        <input type="text" id="f-serial" placeholder="Ex: AE001">
        <div class="emsg" id="e-serial"></div>
      </div>
      <div class="frow">
        <div><label>Prenom *</label><input type="text" id="f-prenom" placeholder="Prenom"><div class="emsg" id="e-prenom"></div></div>
        <div><label>Nom *</label><input type="text" id="f-nom" placeholder="Nom"><div class="emsg" id="e-nom"></div></div>
      </div>
      <div><label>üìÖ Date de naissance</label><input type="date" id="f-dob"></div>
      <div><label>üìç Adresse</label><input type="text" id="f-adresse" placeholder="Adresse complete"></div>
      <div>
        <label>üìû Telephone WhatsApp *</label>
        <input type="tel" id="f-tel" placeholder="0661372227" oninput="chkTel('f-tel','e-tel')">
        <div class="emsg" id="e-tel"></div>
      </div>
      <div><label>‚úâÔ∏è Gmail</label><input type="email" id="f-email" placeholder="exemple@gmail.com"></div>
      <div>
        <label>üìã Statut</label>
        <select id="f-statut">
          <option value="en-cours">üîµ En cours</option>
          <option value="reussi">üü¢ Reussi</option>
          <option value="echoue">üî¥ Echoue</option>
          <option value="abandonne">‚ö´ Abandonne</option>
        </select>
      </div>
      <div class="stitle">üí∞ Paiement</div>
      <div><label>Prix total (DH) *</label><input type="number" id="f-prix" placeholder="Ex: 3000"><div class="emsg" id="e-prix"></div></div>
      <div><label>Premiere avance (DH)</label><input type="number" id="f-avance" placeholder="Ex: 500"></div>
      <button class="btn btn-blue btn-full" onclick="addClient()">‚úÖ Enregistrer le client</button>
    </div>
  </div>
</div>

<div id="page-pub" class="page">
  <div class="card">
    <div class="ctitle"><div class="cico">üéØ</div> Choisir les destinataires</div>
    <div class="pgfltrs">
      <div class="pgf on" data-p="tous" onclick="setPG(this)">üë• Tous les clients</div>
      <div class="pgf" data-p="impaye" onclick="setPG(this)">‚ùó Impayes</div>
      <div class="pgf" data-p="solde" onclick="setPG(this)">‚úÖ Soldes</div>
      <div class="pgf" data-p="en-cours" onclick="setPG(this)">üîµ En cours</div>
      <div class="pgf" data-p="reussi" onclick="setPG(this)">üü¢ Reussis</div>
      <div class="pgf" data-p="echoue" onclick="setPG(this)">üî¥ Echoues</div>
    </div>
    <div id="pg-count" style="font-size:12px;color:var(--blue);font-weight:700;margin-bottom:10px;"></div>
    <div class="stitle">‚úçÔ∏è Message pour ce groupe</div>
    <p style="font-size:10px;color:var(--gray);margin-bottom:6px;">Variables : [prenom] [nom] [reste] ‚Äî message sauvegarde par groupe üíæ</p>
    <textarea id="pg-msg" rows="7" oninput="savePGMsg();renderPGList()"></textarea>
    <div style="margin-top:10px;"><button class="btn btn-out btn-full" onclick="copyNums()">üìã Copier tous les numeros</button></div>
  </div>
  <div class="card">
    <div class="ctitle"><div class="cico">üì§</div> Envoyer un par un</div>
    <p style="font-size:12px;color:var(--gray);margin-bottom:10px;">Appuyez sur üí¨ Envoyer ‚Äî WhatsApp s'ouvre avec le message personnalise !</p>
    <div id="pg-list"></div>
  </div>
</div>

<div id="page-export" class="page">
  <div class="card">
    <div class="ctitle"><div class="cico">üì§</div> Exporter vos donnees</div>
    <div class="expbtns">
      <button class="btn btn-green btn-full" onclick="expCSV()">üìä Export Excel</button>
      <button class="btn btn-red btn-full" onclick="expPDF()">üìÑ Export PDF</button>
      <button class="btn btn-blue btn-full" onclick="expJSON()">üíæ Sauvegarde</button>
      <button class="btn btn-orange btn-full" onclick="impJSON()">üì• Importer</button>
    </div>
    <input type="file" id="imp-file" accept=".json" style="display:none" onchange="doImport(event)">
  </div>
  <div class="card">
    <div class="ctitle"><div class="cico">üìã</div> Apercu clients</div>
    <div id="exp-preview" style="overflow-x:auto;font-size:12px;"></div>
  </div>
</div>

<div class="modal-bg" id="mbg" onclick="closeMif(event)">
  <div class="modal"><div class="mhandle"></div><div id="mcontent"></div></div>
</div>
<div class="toast" id="toast"></div>

<script>
var clients=[];var cFilter="tous";var pgFilter="tous";var pgMsgs={};var DEF_MSGS={};
function initMsgs(){
  DEF_MSGS["tous"]="Bonjour [prenom] !\n\nAuto-Ecole AchkounE\nTel: 06 61 37 22 27\n\nNous esperons que vous allez bien.\nN hesitez pas a nous contacter.\n\nMerci de votre confiance !";
  DEF_MSGS["impaye"]="Bonjour [prenom] !\n\nAuto-Ecole AchkounE\nTel: 06 61 37 22 27\n\nVotre reste a payer est de : [reste]\n\nMerci de regulariser votre situation.\nPour tout arrangement, appelez-nous !\n\nMerci";
  DEF_MSGS["solde"]="Bonjour [prenom] !\n\nAuto-Ecole AchkounE\nTel: 06 61 37 22 27\n\nFelicitations ! Votre dossier est entierement solde.\n\nMerci pour votre confiance et bonne route !";
  DEF_MSGS["en-cours"]="Bonjour [prenom] !\n\nAuto-Ecole AchkounE\nTel: 06 61 37 22 27\n\nVotre formation est en cours. Continuez vos efforts !\n\nPour planifier vos prochaines lecons, contactez-nous.\n\nBonne chance !";
  DEF_MSGS["reussi"]="Bravo [prenom] !\n\nAuto-Ecole AchkounE\nTel: 06 61 37 22 27\n\nToute l equipe vous felicite pour votre reussite !\n\nBonne route et conduisez prudemment !";
  DEF_MSGS["echoue"]="Bonjour [prenom] !\n\nAuto-Ecole AchkounE\nTel: 06 61 37 22 27\n\nNe vous decouragez pas ! C est temporaire.\n\nNous sommes la pour vous aider a reussir au prochain examen.\n\nCourage !";
}
function loadData(){try{var c=localStorage.getItem("ach3");clients=c?JSON.parse(c):[];}catch(e){clients=[];}try{var m=localStorage.getItem("ach3m");pgMsgs=m?JSON.parse(m):{};}catch(e){pgMsgs={};}}
function saveData(){try{localStorage.setItem("ach3",JSON.stringify(clients));}catch(e){}updateHeader();updateDash();}
function saveMsgs(){try{localStorage.setItem("ach3m",JSON.stringify(pgMsgs));}catch(e){}}
function getReste(c){var p=0;if(c.avances){for(var i=0;i<c.avances.length;i++)p+=Number(c.avances[i].montant);}return Math.max(0,Number(c.prix)-p);}
function getPaye(c){var p=0;if(c.avances){for(var i=0;i<c.avances.length;i++)p+=Number(c.avances[i].montant);}return p;}
function fmtNum(n){return Number(n).toLocaleString("fr-FR");}
function today(){var d=new Date();return d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getFullYear();}
function showToast(msg){var t=document.getElementById("toast");t.textContent=msg;t.className="toast on";setTimeout(function(){t.className="toast";},2500);}
function goTab(tab,btn){var ps=document.querySelectorAll(".page");for(var i=0;i<ps.length;i++)ps[i].className="page";var nb=document.querySelectorAll(".nbtn");for(var i=0;i<nb.length;i++)nb[i].className="nbtn";document.getElementById("page-"+tab).className="page on";if(btn)btn.className="nbtn on";if(tab==="clients")renderClients();if(tab==="pub"){loadPGMsg();updatePGCount();renderPGList();}if(tab==="export")renderExpPreview();}
function updateHeader(){document.getElementById("h-total").textContent=clients.length;var r=0;for(var i=0;i<clients.length;i++)r+=getReste(clients[i]);document.getElementById("h-reste").textContent=fmtNum(r);}
function updateDash(){document.getElementById("d-total").textContent=clients.length;var ca=0,py=0,re=0,rs=0,ec=0;for(var i=0;i<clients.length;i++){ca+=Number(clients[i].prix)||0;py+=getPaye(clients[i]);re+=getReste(clients[i]);if(clients[i].statut==="reussi")rs++;if(clients[i].statut==="echoue")ec++;}document.getElementById("d-ca").textContent=fmtNum(ca);document.getElementById("d-paye").textContent=fmtNum(py);document.getElementById("d-reste").textContent=fmtNum(re);document.getElementById("d-reussi").textContent=rs;document.getElementById("d-echoue").textContent=ec;var deb=[];for(var i=0;i<clients.length;i++){if(getReste(clients[i])>0)deb.push(clients[i]);}var el=document.getElementById("d-impay");if(deb.length===0){el.innerHTML='<div class="empty"><div class="eico">&#127881;</div><p style="font-size:13px">Tous les clients sont a jour !</p></div>';}else{var h="";for(var i=0;i<deb.length;i++){var c=deb[i];h+='<div class="aitem" style="cursor:pointer" onclick="openClient(\''+c.id+'\')"><div><div style="font-weight:700;font-size:13px">&#128100; '+c.prenom+" "+c.nom+'</div><div style="font-size:10px;color:var(--gray)">&#128222; '+c.tel+"</div></div><div style='color:var(--red);font-weight:700;font-size:13px'>"+fmtNum(getReste(c))+" DH</div></div>";}el.innerHTML=h;}}
function setF(f,btn){cFilter=f;var fb=document.querySelectorAll(".fbtn");for(var i=0;i<fb.length;i++)fb[i].className="fbtn";btn.className="fbtn on";renderClients();}
function getFiltCl(){var q=document.getElementById("srch")?document.getElementById("srch").value.toLowerCase():"";var list=[];for(var i=0;i<clients.length;i++){var c=clients[i];var s=(c.prenom+" "+c.nom+" "+c.serial+" "+c.tel).toLowerCase();if(q&&s.indexOf(q)===-1)continue;if(cFilter==="tous"){list.push(c);continue;}if(cFilter==="solde"&&getReste(c)===0){list.push(c);continue;}if(cFilter==="impaye"&&getReste(c)>0){list.push(c);continue;}if(cFilter===c.statut){list.push(c);continue;}}return list;}
function stInfo(s){if(s==="reussi")return{lbl:"&#127881; Reussi",cls:"b-reussi"};if(s==="echoue")return{lbl:"&#10060; Echoue",cls:"b-echoue"};if(s==="abandonne")return{lbl:"&#9899; Abandonne",cls:"b-abandonne"};return{lbl:"&#128309; En cours",cls:"b-encours"};}
function renderClients(){var list=getFiltCl();var el=document.getElementById("clist");if(list.length===0){el.innerHTML='<div class="empty"><div class="eico">&#128101;</div><p>Aucun client trouve</p></div>';return;}var h="";for(var i=0;i<list.length;i++){var c=list[i];var py=getPaye(c);var re=getReste(c);var pct=c.prix>0?Math.min(100,Math.round(py/c.prix*100)):0;var si=stInfo(c.statut);var pb=re===0?'<span class="badge b-solde">&#9989; Solde</span>':pct>0?'<span class="badge b-partiel">&#8987; Partiel</span>':'<span class="badge b-nonpaye">&#10069; Non paye</span>';var waN="212"+c.tel.replace(/^0/,"").replace(/\s/g,"");h+='<div class="citem"><div class="chead"><div><div class="cname">&#128100; '+c.prenom+" "+c.nom+'</div><div class="cserial">&#128273; '+c.serial+" &mdash; "+c.createdAt+'</div></div><div class="cbadges"><span class="badge '+si.cls+'">'+si.lbl+"</span>"+pb+'</div></div><div class="cinfo"><span>&#128222; '+c.tel+"</span><span>&#128197; "+(c.dob||"N/A")+"</span><span>&#128176; "+fmtNum(c.prix)+" DH</span><span style='color:var(--red)'>&#9203; "+fmtNum(re)+" DH</span></div>"+'<div class="pbar"><div class="pfill" style="width:'+pct+'%"></div></div>'+'<div class="divider"><span>&#9989; '+fmtNum(py)+" DH ("+pct+"%)  </span><span style='color:var(--red);font-weight:700'>&#8987; "+fmtNum(re)+" DH restant</span></div>"+'<div class="cfoot"><a href="https://wa.me/'+waN+'" target="_blank" class="btn btn-wa btn-sm">&#128172; WA</a><button class="btn btn-blue btn-sm" onclick="openClient(\''+c.id+'\')">&#128176; Details</button><button class="btn btn-orange btn-sm" onclick="openEdit(\''+c.id+'\')">&#9998; Modifier</button><button class="btn btn-red btn-sm" onclick="delClient(\''+c.id+'\')">&#128465;</button></div></div>';}el.innerHTML=h;}
function chkTel(iid,eid){var v=document.getElementById(iid).value.replace(/\s/g,"");var e=document.getElementById(eid);var inp=document.getElementById(iid);if(v&&!/^0[5-7]\d{8}$/.test(v)){e.textContent="Format invalide (ex: 0661372227)";inp.className="einp";}else{e.textContent="";inp.className="";}}
function addClient(){var ok=true;var fs=[{id:"f-serial",err:"e-serial"},{id:"f-prenom",err:"e-prenom"},{id:"f-nom",err:"e-nom"},{id:"f-tel",err:"e-tel"},{id:"f-prix",err:"e-prix"}];for(var i=0;i<fs.length;i++){var v=document.getElementById(fs[i].id).value.trim();var e=document.getElementById(fs[i].err);var inp=document.getElementById(fs[i].id);if(!v){e.textContent="Ce champ est obligatoire";inp.className="einp";ok=false;}else{e.textContent="";inp.className="";}}var tel=document.getElementById("f-tel").value.replace(/\s/g,"");if(tel&&!/^0[5-7]\d{8}$/.test(tel)){document.getElementById("e-tel").textContent="Format invalide (ex: 0661372227)";document.getElementById("f-tel").className="einp";ok=false;}var serial=document.getElementById("f-serial").value.trim();for(var i=0;i<clients.length;i++){if(clients[i].serial===serial){document.getElementById("e-serial").textContent="Ce numero existe deja";document.getElementById("f-serial").className="einp";ok=false;break;}}if(!ok){showToast("Corrigez les erreurs");return;}var av=Number(document.getElementById("f-avance").value)||0;var avs=[];if(av>0)avs.push({montant:av,date:today()});var client={id:String(Date.now()),serial:serial,prenom:document.getElementById("f-prenom").value.trim(),nom:document.getElementById("f-nom").value.trim(),dob:document.getElementById("f-dob").value,adresse:document.getElementById("f-adresse").value.trim(),tel:tel,email:document.getElementById("f-email").value.trim(),statut:document.getElementById("f-statut").value,prix:Number(document.getElementById("f-prix").value),avances:avs,createdAt:today()};clients.push(client);saveData();var ids=["f-serial","f-prenom","f-nom","f-dob","f-adresse","f-tel","f-email","f-prix","f-avance"];for(var i=0;i<ids.length;i++)document.getElementById(ids[i]).value="";document.getElementById("f-statut").value="en-cours";showToast("&#10003; Client enregistre !");goTab("clients",document.querySelectorAll(".nbtn")[1]);}
function openClient(id){var c=null;for(var i=0;i<clients.length;i++){if(clients[i].id===id){c=clients[i];break;}}if(!c)return;var py=getPaye(c);var re=getReste(c);var pct=c.prix>0?Math.min(100,Math.round(py/c.prix*100)):0;var avH="";if(!c.avances||c.avances.length===0){avH='<p style="font-size:12px;color:var(--gray)">Aucune avance enregistree</p>';}else{for(var i=0;i<c.avances.length;i++){var a=c.avances[i];avH+='<div class="aitem"><div><div class="aamt">&#10133; '+fmtNum(a.montant)+' DH</div><div class="adate">&#128197; '+a.date+'</div></div><button onclick="delAvance(\''+id+'\','+i+')" style="background:none;border:none;font-size:18px;cursor:pointer">&#128465;</button></div>';}}var waN="212"+c.tel.replace(/^0/,"").replace(/\s/g,"");var si=stInfo(c.statut);var h='<h2 style="font-size:16px;font-weight:800;margin-bottom:6px">&#128100; '+c.prenom+" "+c.nom+'</h2><div style="display:flex;gap:6px;margin-bottom:12px"><span class="badge '+si.cls+'">'+si.lbl+"</span>"+(re===0?'<span class="badge b-solde">&#9989; Solde</span>':'<span class="badge b-nonpaye">&#9203; '+fmtNum(re)+" DH</span>")+'</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;font-size:12px;background:var(--bg);border-radius:10px;padding:10px;margin-bottom:12px"><div>&#128273; '+c.serial+'</div><div>&#128197; '+(c.dob||"N/A")+'</div><div>&#128222; '+c.tel+'</div><div>&#128231; '+(c.email||"N/A")+'</div><div style="grid-column:1/-1">&#128205; '+(c.adresse||"N/A")+'</div></div><div class="psum"><div class="prow"><span>&#128176; Prix total</span><span class="pamt">'+fmtNum(c.prix)+' DH</span></div><div class="prow"><span>&#9989; Total paye</span><span class="pamt grn">'+fmtNum(py)+' DH</span></div><div class="pbar"><div class="pfill" style="width:'+pct+'%"></div></div><div style="text-align:center;font-size:11px;color:var(--gray);margin:-2px 0 6px">'+pct+'% paye</div><div class="prow"><span>&#9203; Reste a payer</span><span class="pamt red">'+fmtNum(re)+' DH</span></div></div><div class="stitle">&#128197; Historique avances</div>'+avH+'<div class="stitle">&#10133; Ajouter une avance</div><div style="display:flex;gap:8px;margin-bottom:12px"><input type="number" id="nav-amt" placeholder="Montant DH" style="flex:1"><button class="btn btn-green" onclick="addAvance(\''+id+'\')">&#10133; Ajouter</button></div><div style="display:flex;gap:8px"><a href="https://wa.me/'+waN+'" target="_blank" class="btn btn-wa" style="flex:1">&#128172; WhatsApp</a><button class="btn btn-out" style="flex:1" onclick="closeM()">Fermer</button></div>';document.getElementById("mcontent").innerHTML=h;document.getElementById("mbg").className="modal-bg on";}
function openEdit(id){var c=null;for(var i=0;i<clients.length;i++){if(clients[i].id===id){c=clients[i];break;}}if(!c)return;var sts=["en-cours","reussi","echoue","abandonne"];var sls=["En cours","Reussi","Echoue","Abandonne"];var opts="";for(var i=0;i<sts.length;i++){opts+='<option value="'+sts[i]+'"'+(c.statut===sts[i]?" selected":"")+">"+sls[i]+"</option>";}var h='<h2 style="font-size:15px;font-weight:800;margin-bottom:14px">&#9998; Modifier &mdash; '+c.prenom+" "+c.nom+'</h2><div class="fg"><div><label>&#128273; Numero de serie</label><input id="es-v" value="'+c.serial+'"><div class="emsg" id="es-err"></div></div><div class="frow"><div><label>Prenom</label><input id="ep-v" value="'+c.prenom+'"></div><div><label>Nom</label><input id="en-v" value="'+c.nom+'"></div></div><div><label>&#128197; Date naissance</label><input type="date" id="ed-v" value="'+(c.dob||"")+'"></div><div><label>&#128205; Adresse</label><input id="ea-v" value="'+(c.adresse||"")+'"></div><div><label>&#128222; Telephone</label><input type="tel" id="et-v" value="'+c.tel+'" oninput="chkTel(\'et-v\',\'et-err\')"><div class="emsg" id="et-err"></div></div><div><label>&#128231; Gmail</label><input type="email" id="ee-v" value="'+(c.email||"")+'"></div><div><label>&#128203; Statut</label><select id="ess-v">'+opts+'</select></div><div><label>&#128176; Prix total DH</label><input type="number" id="epx-v" value="'+c.prix+'"></div><div style="display:flex;gap:8px;margin-top:4px"><button class="btn btn-blue" style="flex:1" onclick="saveEdit(\''+id+'\')">&#128190; Enregistrer</button><button class="btn btn-gray" style="flex:1" onclick="closeM()">Annuler</button></div></div>';document.getElementById("mcontent").innerHTML=h;document.getElementById("mbg").className="modal-bg on";}
function saveEdit(id){var c=null;for(var i=0;i<clients.length;i++){if(clients[i].id===id){c=clients[i];break;}}if(!c)return;var tel=document.getElementById("et-v").value.replace(/\s/g,"");if(tel&&!/^0[5-7]\d{8}$/.test(tel)){document.getElementById("et-err").textContent="Format invalide (ex: 0661372227)";return;}c.serial=document.getElementById("es-v").value.trim();c.prenom=document.getElementById("ep-v").value.trim();c.nom=document.getElementById("en-v").value.trim();c.dob=document.getElementById("ed-v").value;c.adresse=document.getElementById("ea-v").value.trim();c.tel=tel;c.email=document.getElementById("ee-v").value.trim();c.statut=document.getElementById("ess-v").value;c.prix=Number(document.getElementById("epx-v").value);saveData();closeM();renderClients();showToast("Modifications enregistrees !");}
function addAvance(id){var c=null;for(var i=0;i<clients.length;i++){if(clients[i].id===id){c=clients[i];break;}}if(!c)return;var amt=Number(document.getElementById("nav-amt").value);if(!amt||amt<=0){showToast("Montant invalide");return;}if(!c.avances)c.avances=[];c.avances.push({montant:amt,date:today()});saveData();openClient(id);renderClients();showToast("Avance ajoutee !");}
function delAvance(id,idx){var c=null;for(var i=0;i<clients.length;i++){if(clients[i].id===id){c=clients[i];break;}}if(!c)return;c.avances.splice(idx,1);saveData();openClient(id);renderClients();showToast("Avance supprimee");}
function delClient(id){if(!confirm("Supprimer ce client ?"))return;var nl=[];for(var i=0;i<clients.length;i++){if(clients[i].id!==id)nl.push(clients[i]);}clients=nl;saveData();renderClients();showToast("Client supprime");}
function closeM(){document.getElementById("mbg").className="modal-bg";}
function closeMif(e){if(e.target===document.getElementById("mbg"))closeM();}
function setPG(el){var pgs=document.querySelectorAll(".pgf");for(var i=0;i<pgs.length;i++)pgs[i].className="pgf";el.className="pgf on";pgFilter=el.getAttribute("data-p");loadPGMsg();updatePGCount();renderPGList();}
function getPGCl(){var list=[];for(var i=0;i<clients.length;i++){var c=clients[i];if(pgFilter==="tous"){list.push(c);continue;}if(pgFilter==="impaye"&&getReste(c)>0){list.push(c);continue;}if(pgFilter==="solde"&&getReste(c)===0){list.push(c);continue;}if(pgFilter===c.statut){list.push(c);continue;}}return list;}
function loadPGMsg(){var msg=pgMsgs[pgFilter]!==undefined?pgMsgs[pgFilter]:(DEF_MSGS[pgFilter]||DEF_MSGS["tous"]);document.getElementById("pg-msg").value=msg;}
function savePGMsg(){pgMsgs[pgFilter]=document.getElementById("pg-msg").value;saveMsgs();}
function updatePGCount(){var list=getPGCl();document.getElementById("pg-count").textContent="&#128101; "+list.length+" client(s) selectionne(s)";}
function getWALink(c){var msg=document.getElementById("pg-msg").value;msg=msg.replace(/\[prenom\]/gi,c.prenom);msg=msg.replace(/\[nom\]/gi,c.nom);msg=msg.replace(/\[reste\]/gi,fmtNum(getReste(c))+" DH");var num="212"+c.tel.replace(/^0/,"").replace(/\s/g,"");return"https://wa.me/"+num+"?text="+encodeURIComponent(msg);}
function renderPGList(){var list=getPGCl();var el=document.getElementById("pg-list");if(list.length===0){el.innerHTML='<p style="font-size:13px;color:var(--gray)">Aucun client dans cette selection</p>';return;}var h="";for(var i=0;i<list.length;i++){var c=list[i];var re=getReste(c);h+='<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)"><div><div style="font-weight:700;font-size:13px">&#128100; '+(i+1)+". "+c.prenom+" "+c.nom+'</div><div style="font-size:11px;color:var(--gray)">&#128222; '+c.tel+(re>0?' &mdash; <span style="color:var(--red);font-weight:600">&#9203; '+fmtNum(re)+' DH</span>':' &mdash; <span style="color:var(--green);font-weight:600">&#9989; Solde</span>')+'</div></div><a href="'+getWALink(c)+'" target="_blank" class="btn btn-wa btn-sm">&#128172; Envoyer</a></div>';}el.innerHTML=h;}
function copyNums(){var list=getPGCl();if(list.length===0){showToast("Aucun client");return;}var nums=[];for(var i=0;i<list.length;i++)nums.push(list[i].tel);try{navigator.clipboard.writeText(nums.join("\n")).then(function(){showToast(nums.length+" numeros copies !");});}catch(e){showToast("Numeros: "+nums.join(", "));}}
function renderExpPreview(){var el=document.getElementById("exp-preview");if(clients.length===0){el.innerHTML="<p>Aucun client</p>";return;}var h='<table style="width:100%;border-collapse:collapse;font-size:11px"><tr style="background:var(--blue);color:white"><th style="padding:5px">Serie</th><th>Nom</th><th>Tel</th><th>Prix</th><th>Paye</th><th>Reste</th></tr>';for(var i=0;i<clients.length;i++){var c=clients[i];var bg=i%2?"var(--bg)":"white";h+='<tr style="background:'+bg+'"><td style="padding:4px">'+c.serial+"</td><td>"+c.prenom+" "+c.nom+"</td><td>"+c.tel+"</td><td>"+c.prix+"</td><td>"+getPaye(c)+"</td><td style='color:var(--red);font-weight:700'>"+getReste(c)+"</td></tr>";}h+="</table>";el.innerHTML=h;}
function expCSV(){var rows=["Serie,Prenom,Nom,DateNaissance,Adresse,Telephone,Email,Statut,Prix,TotalPaye,Reste,DateInscription"];for(var i=0;i<clients.length;i++){var c=clients[i];rows.push([c.serial,c.prenom,c.nom,c.dob||"",c.adresse||"",c.tel,c.email||"",c.statut||"en-cours",c.prix,getPaye(c),getReste(c),c.createdAt].map(function(v){return'"'+v+'"';}).join(","));}dl("achkoune-clients.csv","data:text/csv;charset=utf-8,\uFEFF"+encodeURIComponent(rows.join("\n")));showToast("Export CSV telecharge !");}
function expPDF(){var w=window.open("","_blank");var rows="";for(var i=0;i<clients.length;i++){var c=clients[i];rows+="<tr><td>"+c.serial+"</td><td>"+c.prenom+" "+c.nom+"</td><td>"+c.tel+"</td><td>"+(c.statut||"")+"</td><td>"+c.prix+" DH</td><td>"+getPaye(c)+" DH</td><td style='color:red;font-weight:bold'>"+getReste(c)+" DH</td></tr>";}w.document.write("<html><head><title>AchkounE</title><style>body{font-family:Arial;font-size:12px}h1{color:#1a56db}table{width:100%;border-collapse:collapse}th{background:#1a56db;color:white;padding:7px}td{padding:5px;border-bottom:1px solid #eee}</style></head><body><h1>Auto-Ecole AchkounE - Liste Clients</h1><p>Exporte le "+today()+" - "+clients.length+" clients</p><table><tr><th>Serie</th><th>Nom</th><th>Tel</th><th>Statut</th><th>Prix</th><th>Paye</th><th>Reste</th></tr>"+rows+"</table></body></html>");w.document.close();w.print();}
function expJSON(){dl("achkoune-backup.json","data:application/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(clients,null,2)));showToast("Sauvegarde JSON telechargee !");}
function impJSON(){document.getElementById("imp-file").click();}
function doImport(e){var file=e.target.files[0];if(!file)return;var reader=new FileReader();reader.onload=function(ev){try{var data=JSON.parse(ev.target.result);if(!Array.isArray(data))throw new Error();clients=data;saveData();showToast(clients.length+" clients importes !");renderClients();}catch(err){showToast("Fichier invalide");}};reader.readAsText(file);}
function dl(filename,dataUrl){var a=document.createElement("a");a.href=dataUrl;a.download=filename;a.click();}
initMsgs();loadData();updateHeader();updateDash();renderClients();
setTimeout(function(){loadPGMsg();updatePGCount();renderPGList();},200);
</script>
</body>
</html>
